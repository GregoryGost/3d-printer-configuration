# Калибровка принтера для Klipper

3D принтер **Ender 3 Pro** с апгрейдами:

* Исполнительная плата **BigTreeTech SKR Mini E3 v2.0**
* Управляющая плата **BigTreeTech BTT-PI v1.2**
* Экструдер **BMG clone**
* Хотенд **E3DV6**
* Датчик уровня стола **Trianglelab 2021 v3 3D Touch**
* Собственное спроектированное крепление **E3BMGS - Крепление директ BMG(clone) + E3DV6 экструдер**

## Порядок калибровки

0. Механика и электрика собраны как следует. Точно?
1. Калибровка PID Экструдера и Стола
2. Калибровка шагов/разрешения экструдера
3. Калибровка стола (z-offset)
4. Калибровка pressure advance
5. Калибровка откатов (fw-retract)
6. Калибровка потока
7. Калибровка шейперов - Input Shaping (ускорения)

## Видео материалы и литература

Порядок калибровки основан на материалах:

* <Дмитрий Соркин>: [Как увеличить точность 3D принтера?](https://youtu.be/POG_Th2k3_I)
* <Дмитрий Соркин>: [Калибровка PID](https://youtu.be/doenKnVk0Ec?t=937)
* [Klipper Wiki - Rotation Distance](https://klipper.wiki/ru/home/tuning/rotation)
* <Дмитрий Соркин>: [Калибровка Pressure Advance](https://k3d.tech/calibrations/la/)

### 1. Калибровка PID Экструдера и Стола

Калибровка PID для экструдера.  
Важно чтобы в конфигурации принтера параметр **max_temp** был больше чем калибровочное значение.
Пример: `max_temp: 280` для тестов на 250 градусах

```shell
PID_CALIBRATE HEATER=extruder TARGET=250
```

Калибровка PID для стола. `max_temp: 130`

```shell
PID_CALIBRATE HEATER=heater_bed TARGET=100
```

После окончания калибровки в консоль Web интерфейса выведет откалиброванные параметры `pid_Kp`, `pid_Ki` и `pid_Kd`.  
Вносим их в конфигурацию принтера в разделы `[extruder]` и `[heater_bed]`

### 2. Калибровка шагов/разрешения экструдера

Калибровка отличается от Marlin и немного сложнее.

#### Если ранее была проведена калибровка в Marlin, то можно пересчитать это значение

В Klipper для этого используется параметр `rotation_distance`

В Marlin выставляется так: `DEFAULT_AXIS_STEPS_PER_UNIT {80, 80, 400, 410.7} | X, Y, Z [, I [, J [, K...]]], E0 [, E1[, E2...]]`

E0 = **410.7** Steps Per Unit

Формула: `rotation_distance` = `full_steps_per_rotation` * `microsteps` / `steps_per_mm`  
где:  

* `full_steps_per_rotation` - из документации к шаговикам. Если шаговик с углом 1.8, то для него 200 шагов на оборот
(для угла 0.9 будет уже 400 шагов на оборот)
* `microsteps` - микрошаги драйвера. Можно/нужно найти в параметрах экструдера `[extruder]`, но обычно 16

`rotation_distance = 200 * 16 / 410.7 = 7.7915`

Вставляем в раздел `[extruder]` значение `rotation_distance: 7.7915`

**!!! `gear_ratio` тут не используем !!!**

#### Если сразу Klipper

В случае использования редукторов - указывается коэффициент редукции. Для BMG клонов как правило `3:1`

Чтобы посчитать, нужно замерить диаметр шестерни по зубьям.

Формула: (`π` * `gear_diameter`) / `full_steps_per_rotation`

К примеру диаметр шестерни 7 мм.

`(3,14159 * 7) / 200 = 21.99113 / 200 = 0.10995565 ~ 0.1099`

Вставляем в раздел `[extruder]` значение `rotation_distance: 0.1099` и если с редукцией, то `gear_ratio: 3:1`

#### Калибровка

Калибруем исключительно подающую часть без нагрузки. БЕЗ ГОРЛА И СОПЛА!!!

В конфигурации экструдера [extruder] убираем защиты

```ini
min_extrude_temp: 0
max_extrude_only_distance: 150
```

Подаем команду на подачу 100мм прутка.

```gcode
G1 E100 F600
```

NRD - **New Rotation Distance**  
ORD - Old Rotation Distance  
RL - Required Length  
FL - Fact Length

`NRD = ORD * (RL/FL)`

Пример:  
ORD=7.9, RL=100, FL=112, NRD=7.9*(100/112)=7.05

Вставляем в раздел `[extruder]` значение `rotation_distance: 7.05`

### 3. Калибровка стола (z-offset)

Т.к. установлен датчик автоуровня (клон BLTouch) и настройка стола будет с его помощью.

!!! Датчик должен быть уже настроен !!!

!!! Проводим первично настройку через бумажку !!!

#### Z-offset

Указываем в разделе `[bltouch]` значение в 10мм `z_offset: 10`

Далее делаем Home Z

После этого берем бумажку и двигаем по немногу сопло вниз пока бумажка не коснется сопла и не станет немного туговато двигаться под прижимом сопла.

Смотрим на полчившееся значение по оси Z. Вычитаем из 10 полученное и получаем итоговый z-offset

Пример:  
10 - 8.3 = **1.7**

#### Screws Tilt Adjust

Хоумим все оси и далее двигаем экструдер к каждому винту стола

```text
            FRONT
      2---------------1
RIGHT |                  LEFT
      3---------------4
            BACK
```

Далее указываем в конфигурации принтера

```ini
[screws_tilt_adjust]
screw1: 70,18
screw1_name: Front-Left
screw2: 235,18
screw2_name: Front-Right
screw3: 235,187
screw3_name: Back-Right
screw4: 70,187
screw4_name: Back-Left
horizontal_move_z: 10
speed: 200
screw_thread: CW-M3
```

* `horizontal_move_z` - скорость движения по оси Z
* `speed` - скорость перемещений
* `screw_thread` - CW-M3 - это ClockWork(по часовой стрелке) и резьба M3

После этого в Toolhead выбриаем `SCREWS TILT CALCULATE`

Принтер сам пройдет по нужным точкам и выведет информацию о том, на сколько минут (по часам) и в какую сторону нужно повернуть рукоять винта.

После этого снятие карты стола будет сильно лучше, чем настройка руками.

### 4. Калибровка Pressure Advance

Используем Web калибровщик для создания нужного G-кода по своим параметрам: <https://k3d.tech/calibrations/la/calibrator/>

Полученные значения не фиксируем в конфиге. Их нужно фиксировать в слайсере.
Klipper не поддерживает команду M900 из Marlin, но можно создать макрос, который преобразуем этот G-код в команды Klipper.
А также будет сообщать о выставленных значениях в Web консоль

```ini
[gcode_macro M900]
# M900 K{pressure_factor} S{pressure_smooth_time}
description: Replace M900 Linear Advance
gcode:
  {% set K = params.K|default(0.0)|float %}
  {% set S = params.S|default(0.04)|float %}
  RESPOND TYPE=echo MSG='{"SET PRESSURE_ADVANCE ADVANCE=\"%3.3f\", SMOOTH_TIME=\"%3.3f\"" % (K, S)}'
  SET_PRESSURE_ADVANCE ADVANCE={K} SMOOTH_TIME={S}
```

Далее нужно указывать для конкретного филамента его значение калибровки

К примеру в PrusaSlicer в меню `Настройки филамента` -> `Пользовательский G-код` -> `Стартовый G-код` добавляем что-то вроде:

```gcode
M900 K0.09 ; K-Factor Linear/Pressure Advance
```

### 5. Калибровка откатов (Firmware retraction)

Используем Web калибровщик для создания нужного G-кода по своим параметрам <https://k3d.tech/calibrations/retractions/calibrator/>

### 6. Калибровка потока

Этот метод калибровки считается устаревшим, но можно его тоже попробовать: [Калибровка экструдера и потока 3D принтера](https://www.youtube.com/watch?v=Mga_ezYDTNI)  
Нужен микрометр, либо цифровой штангенциркуль.

!!! Но лучше выравнивать поток через печать тестовых моделей и подгоняя поток в сторону наилучшего визуального результата.

### 7. Калибровка шейперов - Input Shaping (ускорения)
